name: CI - Build and Test
on:
  push: { branches: [ main ] }
  pull_request: { branches: [ main ] }
jobs:
  backend:
    name: Backend Build (Spring Boot)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with: { distribution: temurin, java-version: '17', cache: maven }
      - name: Build & test (skip ITs/Testcontainers)
        working-directory: backend
        run: mvn -B -DskipITs=true -Dtestcontainers.check.skip=true clean test package
  frontend:
    name: Frontend Build (Vite React)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with: { node-version: '20', cache: 'npm', cache-dependency-path: 'frontend/package-lock.json' }
      - name: Ensure lockfile
        working-directory: frontend
        run: |
          if [ ! -f package-lock.json ]; then npm i --package-lock-only; fi
      - name: Install deps
        working-directory: frontend
        run: npm ci
      - name: Build
        working-directory: frontend
        env:
          VITE_API_BASE: http://localhost:8080
          VITE_AI_URL: http://127.0.0.1:8001
        run: npm run build
  ai:
    name: AI Service (FastAPI) – smoke
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.11' }
      - name: Install deps (non-fatal)
        working-directory: ai
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          python - << 'PY'
import fastapi, pydantic; print("AI smoke OK")
PY
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [backend, frontend, ai]
    steps:
      - run: |
          echo "Backend ✅"
          echo "Frontend ✅"
          echo "AI ✅"
